# 법인카드 자동분류 프로그램 사용 가이드

경리 담당자를 위한 실무 매뉴얼

---

## 월간 처리 프로세스

### STEP 1: 카드사 명세서 다운로드
- 카드사 홈페이지에서 XLSX/CSV 다운로드
- 파일명 예시: `카드이용(3987)25년8월.xlsx`

### STEP 2: 자동 분류 실행
```bash
python3 main.py classify \
  --input "카드이용(3987)25년8월.xlsx" \
  --claude \
  --feedback \
  --card "3987"
```

**결과**:
- `output/분류결과_시간.csv` - 상세 분류 결과
- `output/피드백_분류결과_시간.csv` - 검토 필요 항목

### STEP 3: 최종 확정
```bash
python3 main.py finalize \
  --input "output/분류결과_시간.csv" \
  --card "3987"
```

**결과**:
- `output/법인카드_(8)월_3987.csv` - 최종 확정 파일
- `output/법인카드_(8)월_3987.xlsx` - Excel 파일

### STEP 4: 수동 검토 (필요 시)
1. `피드백_*.csv` 파일 열기
2. `확정용도` 컬럼에 올바른 카테고리 입력
3. 피드백 반영:
```bash
python3 main.py feedback --input "output/피드백_파일.csv"
```

---

## 확정 방법 해석

### 자동확정 (95~98%)
- 신뢰도 높은 분류
- 추가 검토 불필요
- 그대로 사용 가능

### AI수정 (0~5%)
- AI 검토자가 분류 수정
- 검토의견 확인 권장
- 대부분 적절한 수정

### 수동검토필요 (2~5%)
- 신뢰도 매우 낮음 (<0.5)
- 업종 불명확
- 데이터 품질 이슈
- **반드시 수동 확인 필요**

---

## 사용용도 카테고리

### 현재 지원 카테고리
1. 차량유지비(주유)
2. 차량유지비(기타)
3. 중식대
4. 사용료
5. 복리후생비(의료)
6. 소모품비
7. 수수료
8. 세금
9. 기타

### 신규 카테고리 추가 방법
1. AI가 새 카테고리 제안 (예: 접대비)
2. 경리 담당자 검토 및 승인
3. 개발팀에 시스템 프롬프트 업데이트 요청
4. `modules/claude_api.py` 수정

---

## 월간 체크리스트

### 매월 초 (1~5일)
- [ ] 전월 카드사 명세서 다운로드
- [ ] 자동 분류 실행
- [ ] 최종 파일 생성
- [ ] 수동 검토 항목 확인

### 분기별 (3개월마다)
- [ ] 정답 DB 백업 파일 정리
- [ ] 피드백 로그 누적 확인
- [ ] 재학습 권장 메시지 확인 시 재학습

### 연간
- [ ] 전체 정답 DB 품질 검토
- [ ] 카테고리 체계 재정비
- [ ] 시스템 성능 평가

---

## 실제 사용 예시

### 예시 1: 3987 카드 (7월)
```bash
# 분류
python3 main.py classify --input 카드(3987)7월.xlsx --claude --card 3987

# 최종 확정
python3 main.py finalize --input output/분류결과_*.csv --card 3987

# 결과: 법인카드_(7)월_3987.csv/xlsx
# 42건 처리, 97.6% 자동확정, 1건 수동검토
```

### 예시 2: 9980 카드 (6월)
```bash
# 분류
python3 main.py classify --input 9980.xlsx --claude --card 9980

# 최종 확정
python3 main.py finalize --input output/9980_분류결과.csv --card 9980

# 결과: 법인카드_(6)월_9980.csv/xlsx
# 21건 처리, 57.1% 자동확정, 6건 AI수정, 3건 수동검토
```

---

## 주요 통계 해석

### 신뢰도 점수
- **1.0**: 정답 DB 정확 일치 (100% 확실)
- **0.85~0.95**: Fuzzy 매칭 (매우 높음)
- **0.7~0.85**: Claude AI 예측 (높음)
- **0.5~0.7**: AI 예측 (보통, 확인 권장)
- **<0.5**: 불확실 (수동 검토 필수)

### 라벨 출처
- **정확일치**: 정답 DB에 등록된 가맹점
- **Fuzzy**: 유사 가맹점명 매칭 (예: 써브웨이 ↔ 서브웨이)
- **Claude**: AI가 순수 예측
- **Claude+규칙**: AI 예측 + 키워드 검증

---

## 비용 관리

### 비용 절감 팁
1. **정답 DB 확장**: 피드백 기능으로 신규 가맹점 등록
2. **Phase 1만 사용**: `--claude` 플래그 제외 (무료)
3. **배치 처리**: 여러 카드 한 번에 처리

### 예상 비용 (카드당)
```
거래 20건, 미매칭 50%: ~$0.15 (200원)
거래 40건, 미매칭 10%: ~$0.07 (100원)
거래 100건, 미매칭 5%: ~$0.10 (150원)
```

### 월간 예상 (모든 카드)
```
카드 5개, 각 200건, 미매칭 평균 15%:
→ API 호출: 150건
→ 예상 비용: $1~2/월 (1,500~3,000원)
```

---

## 문제 상황별 대응

### 상황 1: "미매칭이 너무 많아요"
**원인**: 신규 가맹점 또는 정답 DB 미등록
**해결**:
1. `--claude` 플래그로 AI 분류 활성화
2. 피드백으로 신규 가맹점 등록
3. 다음 달부터 자동 분류

### 상황 2: "분류가 이상해요"
**원인**: AI 오판 또는 새로운 패턴
**해결**:
1. `피드백_*.csv`에서 `확정용도` 입력
2. `python3 main.py feedback` 실행
3. 정답 DB 자동 업데이트

### 상황 3: "API 오류가 나요"
**원인**: API 키 미설정 또는 만료
**해결**:
1. `.env` 파일 확인
2. API 키 재발급 (https://console.anthropic.com)
3. `ANTHROPIC_API_KEY` 업데이트

### 상황 4: "새 카테고리가 필요해요"
**원인**: 업무 변화로 분류 체계 변경
**해결**:
1. 개발팀에 요청
2. `modules/claude_api.py` 프롬프트 수정
3. 재배포

---

## 팁 & 트릭

### 팁 1: 빠른 검토
```bash
# 피드백 파일만 열어서 확인
# "수동검토필요" 항목만 집중 검토
```

### 팁 2: 배치 처리
```bash
# 여러 카드 한번에
for card in 3987 9980 1234; do
  python3 main.py classify --input ${card}.xlsx --claude --card $card
  python3 main.py finalize --input output/${card}_분류결과.csv --card $card
done
```

### 팁 3: 정기 실행
```bash
# cron 설정 (매월 1일 오전 9시)
0 9 1 * * cd /path/to/card_classifier && ./monthly_process.sh
```

---

## 연락처

**기술 지원**: 개발팀
**업무 문의**: 경리팀
**긴급 상황**: 시스템 관리자
